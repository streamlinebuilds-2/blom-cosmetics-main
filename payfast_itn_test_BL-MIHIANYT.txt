================================================================================
PAFAST ITN WEBHOOK TEST FOR ORDER BL-MIHIANYT
================================================================================

üéØ OBJECTIVE: Test your PayFast ITN webhook to mark order as paid
üìã ORDER DETAILS:
   - Order ID: c7c88c8d-a961-4692-9ae7-fbfacf151e88
   - Order Number: BL-MIHIANYT
   - PayFast Payment ID: BL-19AC5A26DD5
   - Total: R290
   - Status: placed/unpaid
   - Buyer: annamarie ernst (ernstannamarie18@gmail.com)

================================================================================
üöÄ HOW TO TEST YOUR PAYFAST ITN WEBHOOK:
================================================================================

METHOD 1: Using curl (Command Line)
-----------------------------------
curl -X POST https://cute-stroopwafel-203cac.netlify.app/.netlify/functions/payfast-itn \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "merchant_id=10000100&merchant_key=46f0cd694581a&payment_status=COMPLETE&item_name=Order+BL-MIHIANYT&item_description=Payment+for+order+BL-MIHIANYT&custom_str1=BL-MIHIANYT&name_first=annamarie&name_last=ernst&email_address=ernstannamarie18@gmail.com&m_payment_id=BL-19AC5A26DD5&amount=290.00&signature=e2b04e0c7ab2360ec2b7ba60d4b9e6e9"

METHOD 2: Using Postman or similar tool
---------------------------------------
POST URL: https://cute-stroopwafel-203cac.netlify.app/.netlify/functions/payfast-itn
Content-Type: application/x-www-form-urlencoded

Raw form data:
merchant_id=10000100&merchant_key=46f0cd694581a&payment_status=COMPLETE&item_name=Order+BL-MIHIANYT&item_description=Payment+for+order+BL-MIHIANYT&custom_str1=BL-MIHIANYT&name_first=annamarie&name_last=ernst&email_address=ernstannamarie18@gmail.com&m_payment_id=BL-19AC5A26DD5&amount=290.00&signature=e2b04e0c7ab2360ec2b7ba60d4b9e6e9

METHOD 3: Using a test HTTP client (like in n8n, Make, etc.)
------------------------------------------------------------
Configure HTTP Request node:
- Method: POST
- URL: https://cute-stroopwafel-203cac.netlify.app/.netlify/functions/payfast-itn
- Headers: Content-Type: application/x-www-form-urlencoded
- Body: (paste the form data from METHOD 1)

================================================================================
üìã KEY FIELDS FOR ORDER STATUS UPDATE:
================================================================================

The PayFast ITN expects these critical fields to mark your order as paid:

‚úÖ REQUIRED FIELDS:
   - merchant_id: 10000100
   - merchant_key: 46f0cd694581a  
   - payment_status: COMPLETE (THIS IS KEY - must be "COMPLETE" not "complete")
   - m_payment_id: BL-19AC5A26DD5 (your order's payment ID)
   - amount: 290.00 (exact amount)
   - signature: e2b04e0c7ab2360ec2b7ba60d4b9e6e9
   - item_name: Order BL-MIHIANYT

‚úÖ OPTIONAL FIELDS (for customer context):
   - name_first: annamarie
   - name_last: ernst  
   - email_address: ernstannamarie18@gmail.com

================================================================================
üîß WHAT HAPPENS WHEN YOU SEND THE WEBHOOK:
================================================================================

1. ‚úÖ Validates signature matches PayFast format
2. ‚úÖ Checks payment_status = "COMPLETE" 
3. ‚úÖ Finds your order by m_payment_id = "BL-19AC5A26DD5"
4. ‚úÖ Validates amount matches R290.00
5. ‚úÖ Updates order status: "placed" ‚Üí "paid"
6. ‚úÖ Updates payment_status: "unpaid" ‚Üí "paid" 
7. ‚úÖ Sets paid_at timestamp
8. ‚úÖ Triggers new order alert webhook
9. ‚úÖ Marks coupon as used (if any)
10. ‚úÖ Enrolls in courses (if any)
11. ‚úÖ Creates payment record
12. ‚úÖ Generates invoice
13. ‚úÖ Forwards to n8n workflow

================================================================================
üß™ TEST RESULTS YOU SHOULD SEE:
================================================================================

SUCCESS RESPONSE:
‚úÖ HTTP 200 (empty response body)
‚úÖ Order status changed to "paid"
‚úÖ Payment status changed to "paid"  
‚úÖ paid_at timestamp set
‚úÖ New order alert triggered
‚úÖ Invoice generated

FAILURE RESPONSES:
‚ùå HTTP 400: "Invalid signature" (wrong signature)
‚ùå HTTP 400: "Amount mismatch" (wrong amount)
‚ùå HTTP 400: "Order not found" (wrong m_payment_id)
‚ùå HTTP 400: "No m_payment_id" (missing payment ID)
‚ùå HTTP 500: "Missing Supabase config" (env vars not set)

================================================================================
üîç VERIFY THE ORDER WAS MARKED AS PAID:
================================================================================

After sending the webhook, run this query to verify:

SELECT 
    order_number,
    status,
    payment_status,
    total,
    buyer_email,
    paid_at
FROM public.orders 
WHERE id = 'c7c88c8d-a961-4692-9ae7-fbfacf151e88';

EXPECTED RESULT:
- status: "paid"
- payment_status: "paid"  
- paid_at: [timestamp]

================================================================================
üí° TIPS FOR DEBUGGING:
================================================================================

1. Check PayFast ITN logs in your Netlify function logs
2. Verify all field names are exactly as shown (case-sensitive)
3. Ensure amount has exactly 2 decimal places (290.00 not 290)
4. Payment status must be "COMPLETE" (uppercase)
5. Check that your m_payment_id matches exactly: "BL-19AC5A26DD5"

================================================================================
‚ö†Ô∏è  IMPORTANT NOTES:
================================================================================

- This is a TEST webhook - not a real PayFast notification
- The signature is pre-generated for testing purposes
- In production, PayFast generates the signature automatically
- The webhook is idempotent - you can run it multiple times safely
- Only marks as paid if status is not already "paid"

================================================================================